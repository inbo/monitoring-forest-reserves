---
title: "Aanmaak strata"
author: "Anja Leyman"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: FALSE
    number_sections: yes
    fig_caption: yes
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---

# Vraagstelling

DOEL van dit script is om alle beschikbare strata te bundelen in één databank, opgesplitst in  

- statische strata
- dynamische strata
- bodemstrata

Zie gdrive "G:\Mijn Drive\6TeamData\PRJ_BOSECO_ALGEMEEN\PRJ_BR_AanvraagGegevens\!METADATA-ALL_PLOTS\strata\ideeen_strata_bosreservaten.xlsx"

Brondata: 

<!-- 1) de strata aangemaakt door Marc (via overlays in GIS) : "00_Bosreservaten_allecirkels-versieME-2020-11-18.xlsx":  -->
<!-- zie gdrive "G:\Mijn Drive\6TeamData\PRJ_BOSECO_ALGEMEEN\PRJ_BR_AanvraagGegevens\!METADATA-ALL_PLOTS' -->

1) de strata aangemaakt door Marc (via overlays in GIS) : `boseco_alleproefvlakken_centraalpunt_lam72_metinfo.shp` in folder C:\03_BR\1_Dataverwerking\Data\Strata\input_marc

2) strata berekend obv de metingen 
cfr VBI: standtype (LH, NH, gemengd LH, kapvlakte, open plek), foresttype (eiken-beuken..°)


```{r Rm, eval = FALSE}
rm(list=ls())
```

```{r Setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE, 
  fig.width = 9,
  fig.align = TRUE)

library(here)

# libraries & invoergegevens
source(here::here("scripts/Setup.R"))

```


<!-- ```{r import_data} -->
<!-- input1 <- read_xlsx(paste0(path_to_strata, "input_marc/00_Bosreservaten_allecirkels-versieME-2020-11-18.xlsx")) -->
<!-- # file staat onder gdrive ....\PRJ_BOSECO_ALGEMEEN\PRJ_BR_AanvraagGegevens\!METADATA-ALL_PLOTS -->

<!-- input2 <- read_xlsx(paste0(path_to_strata, "input_marc/00_referentiefile-meestcompleet-Bosreservaten_allecirkels.xlsx")) -->

<!-- input3 <- read_xlsx(paste0(path_to_strata, "input_marc/boseco_alleproefvlakken_centraalpunt_lam72_2021-10-11.xlsx")) -->

<!-- input4 <- read_xlsx(paste0(path_to_strata, "input_marc/boseco_alleproefvlakken_centraalpunt_lam72.xlsx")) -->

<!-- # VPN-connectie nodig -->

<!-- test <- read_xlsx("G:/Mijn Drive/6TeamData/PRJ_BOSECO_ALGEMEEN/PRJ_BR_AanvraagGegevens/!METADATA-ALL_PLOTS/00_Bosreservaten_allecirkels-versieME-2020-11-18.xlsx") -->

<!-- test <- foreign::read.dbf("Y:/Vlaanderen/Natuur_Bos/Historisch_Bos/Boshistoriek_2021.dbf") -->
<!-- test <- read.csv("Y:/Vlaanderen/Natuur_Bos/Historisch_Bos/Boshistoriek_2021.dbf") -->
<!-- ``` -->

```{r import_data}
fc_strata <-read_sf(paste0("C:/03_BR/1_Dataprocessing/Data/", "boseco_alleproefvlakken_centraalpunt_lam72_metinfo.shp"), crs = 31370)

df_strata <- fc_strata %>% st_drop_geometry()

```



```{r vgl_inputs}
names(input1)
names(input2)
names(input3)

nrow(input1) == nrow(input2) 
nrow(input1) == 1009
nrow(input3) == 1063

n_distinct(input3$PlotID) == 1055
n_distinct(input1$PlotID) == 1009
n_distinct(input1$PlotID) == nrow(input1)
```


Input3 en 4 bevatten zelfde info => welke is meest recente?

```{r input3_4}
dim(input3) == dim(input4)

summary(input3)
summary(input4)

rm(input4)
```

Beide files lijken exact hetzelfde, enkel anders gesporteerd => input4 verwijderen


```{r dubbels_input3}
dubbels_3 <- input3 %>% 
  group_by(PlotID) %>% 
  summarize(aantal = n()) %>% 
  ungroup() %>% 
  filter(aantal > 1)

check_dubbels_3 <- input3 %>% inner_join(dubbels_3)

```


```{r vgl_input1_3}
nrow(input1) == 1009
nrow(input3) == 1063

vgl_1_3 <- input3 %>% 
  select(1:6) %>% 
  full_join(input1 %>% select(1:3), by = c("PlotID"))

nrow(vgl_1_3) 

# niet in input3
vgl_1_3 %>% filter(is.na(Management))

# niet in input1
vgl_1_3 %>% filter(is.na(Beheer))
```

```{r}

```

```{r make_strata_stat_dyn}
strata_dyn <- strata_xls %>%
  select(plot_id = PlotID, Beheer, LAI = LAI_1ste, VisSky = VisSky_1st, FE_date = FE_1ste) %>%
  mutate(periode = ifelse(!is.na(FE_date), 1, NA),
         VisSky = ifelse(is.na(FE_date), NA, VisSky),
          LAI = ifelse(is.na(FE_date), NA, LAI)
          )
# ?? op welke periode slaat het beheer?

strata_stat <- strata_xls %>%
  select(-Beheer, -PlotSize, -LAI_1ste, -VisSky_1st, -FE_1ste, -Jaar_1ste,
         -Den_1ste, -Veg1_1ste, -Veg2_1ste, -Nle_1ste, -Gle_1ste, -Vle_1ste, -Ndo_1ste, -Vdo_1ste, -VdoL_1ste) %>%
  dplyr::rename(plot_id = PlotID)

table(strata_stat$Textuurkla)
```


```{r save_strata}
con <- odbcConnectAccess2007(dbStrata)

sqlSave(con, strata_xls, "Bosreservaten_allecirkels_ME_20201118_origineel", varTypes = c(FE_1ste="datetime"))
sqlSave(con, strata_stat, "tblPlotStrataStatic")
sqlSave(con, strata_dyn, "tblPlotStrataDynamic", varTypes = c(FE_date="datetime"))

odbcClose(con
```

