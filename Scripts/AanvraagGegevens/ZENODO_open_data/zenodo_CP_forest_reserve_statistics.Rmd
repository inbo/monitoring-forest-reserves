---
title: "Statistics per forest reserve (derived from circular plots) for publication on zenodo"
author: "Anja Leyman"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: FALSE
    number_sections: yes
    fig_caption: yes
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---

# Setup

```{r Rm, eval = FALSE}
rm(list=ls())
```

```{r Setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE, 
  fig.width = 9,
  fig.align = TRUE)

library(here)

# libraries & invoergegevens
source(here::here("scripts/Setup.R"))

```


# Vraagstelling

Dit script heeft als doel een dataset te creëren voor publicatie op zenodo, 
met globale statistieken per bosreservaat.

Op teamoverleg besproken:   

- plot-level resultaten vegetatie en dendrometrie als aparte datasets publiceren
- belangrijkste statistieken, niet tot op niveau diameterklasse, 
maar ev. wel tot op soortniveau of afbraakklasse bij liggend dood hout
- species (latijnse naam) en decaystage mee opnemen (niet via LU-lists)


```{r Path}
# deze worden ook in "Setup.R" gedefinieerd (aanroepen van "Paths.R")
# hier ev. extra "paths" toevoegen indien nodig 

path_to_datarequest <- "C:/03_BR/1_DataVerwerkingBR/Open_data_zenodo/"

path_to_datarequest_gdrive <- paste0(path_to_output_gdrive, "ZENODO_open_data/")
```



# Inladen plotinfo - enkel cirkelplots

```{r eval = FALSE}
plotinfo <- read_vc(file = "plotinfo", root = path_to_forresdat_data) %>% 
  filter(plottype == "CP")
colnames(plotinfo)

list_CP <- plotinfo$plot_id
length(list_CP) == 2205
```


# Inladen lookuplijsten

```{r load_LU_lists, eval = FALSE}
con <- odbcConnectAccess2007(path_to_fieldmap_db)
  
  qSpecies <- sqlFetch(con, "qspecies", stringsAsFactors = FALSE)
  qDecaystage <- sqlFetch(con, "qdecaystage", stringsAsFactors = FALSE)
  qHeightClass <- sqlFetch(con, "qHeightClass_regeneration", stringsAsFactors = FALSE)
  qHerbSpecies <- sqlFetch(con, "qHerbSpecies240810", stringsAsFactors = FALSE)
  qBrowseIndex <- sqlFetch(con, "qBrowsIndex", stringsAsFactors = FALSE)
  
odbcClose(con)
```

```{r eval = FALSE}
qSpecies <- qSpecies %>% 
  select(1:3) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2)

qHerbSpecies <- qHerbSpecies %>% 
  select(1:3) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2)



```

# Statistics

Zie functions_overall_statistics.R 

## Algemeen

Functie `create_statistics()` zou normaliter moeten toelaten om een year-range toe te voegen.
Lukt niet (issue aangemaakt).
Daarom mee opgenomen in de functies.


## Berekenen dendro (met logs en carbon)

```{r overkoepelend_dendro}
dendro_stat <- statistics_dendrometry()

# is een list
for (tablename in names(dendro_stat)) {
  assign(tablename, dendro_stat[[tablename]])
} 

```

```{r}
names(dendro_stat)

```

## Berekenen regeneration


```{r overkoepelend_reg, results = 'hide'}
reg_stat <- statistics_regeneration()

# is een list
for (tablename in names(reg_stat)) {
  assign(tablename, reg_stat[[tablename]])
} 

```

```{r}
names(reg_stat)

```


## Berekenen vegetation

In monitoringrapporten werd als volgt gerapporteerd:   

De resultaten van de inventarisatie van de kruidlaag in 64 proefvlakken van 16 m x 16 m op
de rasterpunten buiten de kernvlakte, worden weergegeven in tabel 4.7. De tabel geeft de
frequentie en de karakteristieke bedekking weer van de waargenomen soorten, in dalende
volgorde van frequentie. De karakteristieke bedekking is de gemiddelde bedekking van een
soort, in de proefvlakken waarin die soort werd waargenomen. Lege proefvlakken worden
dus niet in rekening gebracht bij deze berekening.

Bijschrift: Aantal waarnemingen (#) en karakteristieke bedekking (%) van
vaatplantensoorten in de kruidlaag van 64 proefvlakken op de rasterpunten
buiten de kernvlakte, ...
Bron : herblayer_by_plot

Daarnaast een kaartje met per plot:  
Bijschrift: Aantal soorten en totale bedekking van de kruidlaag in de cirkelplots
Bron : veg_by_plot



```{r overkoepelend_veg, results = 'hide'}
veg_stat <- statistics_vegetation()

# is een list
for (tablename in names(veg_stat)) {
  assign(tablename, veg_stat[[tablename]])
} 

```



```{r}
names(veg_stat)

```

# shapefiles

Enkel deze met cirkelplots verwerkt.

```{r}
list_BR <- plotinfo %>% distinct(forest_reserve)
```

```{r}
path_to_shp <- "G:/Gedeelde drives/Team_Boseco/00_projecten/PRJ_BR_Bosreservaten/gebieden/0_overkoepelend/"

shp <- "bosreservaten_IntensieveMonitoring.shp"

path_to_shp2 <- "G:/Gedeelde drives/Team_Boseco/00_projecten/PRJ_BR_AanvraagGegevens/00_METADATA-ALL_PLOTS/GIS-lagen bosreservaten/alle cirkelplots/"

shp2 <- "Bosreservaten_allecirkels.shp"

```

De shapefile `bosreservaten_IntensieveMonitoring.shp` bevat 17 BR-en

Bevat ook deze met enkel een KV => wegfilteren:
- Hannecartbos
- Rodebos
- Walenbos
- Harras

Anderzijds zijn de volgende reservaten er bij gekomen:
- Zwaenepoel
- Kluisbos
- Ename

Shapefile `Bosreservaten_allecirkels.shp` is correcter/vollediger:

Everzwijnbad (Meerdaalwoud)
Withoefse Heide
Wijnendalebos
Heirnisse
Jansheideberg (Hallerbos)
Ter Rijst
Pruikemakers (Meerdaalwoud)
Liedekerkebos
Sevendonck - eiken-berken
Sevendonck - elzenbroek
Muizenbos
Bos t'Ename
De Heide (Meerdaalwoud)
Kluisbos
Kolmontbos
Kersselaerspleyn (ZoniÔö£┬¢nwoud)
Harras (ZoniÔö£┬¢nwoud)

```{r}

```



# Strata op niveau van BR?

info_forest_reserve_level_EUFORIA
info_forest_reserve_level_management

```{r}
con <- odbcConnectAccess2007(path_to_strata_db)
 strata_tables <- sqlTables(con) %>% filter(!str_detect(TABLE_NAME, "MSys"))
 info_EUFORIA <- sqlFetch(con, "info_forest_reserve_level_EUFORIA", stringsAsFactors = FALSE)
 info_management <- sqlFetch(con, "info_forest_reserve_level_management", stringsAsFactors = FALSE)
odbcClose(con)


names(info_EUFORIA)
names(info_management)

```

```{r info_samenvoegen}
info_BR <- info_EUFORIA %>% 
  filter(plottype == "CP")

info_BR2 <- info_management %>% 
  filter(plottype == "CP")

info_BR %>% anti_join(list_BR)
info_BR2 %>% anti_join(list_BR)
list_BR %>% anti_join(info_BR2)
list_BR %>% anti_join(info_BR) # De heide zit niet mee in data voor euforia, omdat het een managed site is ...
```


```{r info_samenvoegen}
info_BR <- list_BR %>% 
  left_join(info_management %>% filter(plottype == "CP")) %>% 
  left_join(info_EUFORIA %>% filter(plottype == "CP")) %>% 
  mutate(reserve_area_ha = ifelse(forest_reserve == "De heide",
                                  31.2, reserve_area_ha)) %>% 
  select(-contains(c("Id", "plottype")))  #"reserve_name_euforia", 
  
names(info_BR) 

```






# Export 

Dendro (dendro, logs en reg) en vegetatie in afzonderlijke folder (ook afz. publiceren op zenodo)

Reeds als list samengevoegd in de overkoepelden functies, en ook reeds afgerond
(op 2 cijfers na de komma)


```{r list_round_NIET_NODIG, eval = FALSE}
list_dendro <- list(
      dendro_by_plot = dendro_by_plot,
      dendro_by_plot_species = dendro_by_plot_species,
      dendro_by_diam_plot = dendro_by_diam_plot,
      dendro_by_diam_plot_species = dendro_by_diam_plot_species,
      logs_by_decay_plot = logs_by_decay_plot,
      logs_by_decay_plot_species = logs_by_decay_plot_species
      )

list_reg <- list(
      regeneration_by_plot = regeneration_by_plot, 
      regeneration_by_plot_height = regeneration_by_plot_height, 
      regeneration_by_plot_height_species = regeneration_by_plot_height_species
      )

list_veg <- list(vegetation_by_plot = vegetation_by_plot,
              herblayer_by_plot = herblayer_by_plot
              ) # geen afronding nodig

# ----
list_dendro <- list_dendro %>% 
  lapply(., function(x) mutate_at(x, vars(matches("_ha|_tree")), round, 2))

list_reg <- list_reg %>% 
  lapply(., function(x) mutate_at(x, vars(matches("_ha|_tree")), round, 0))

#uitgebreider kan ook
    # list_dendro_ <- list_dendro %>% 
    #   lapply(., function(x) {
    #     data.frame(x) %>% 
    #       mutate_at(vars(matches("_ha|_tree")), round, 2)})

```


```{r list_export, eval = FALSE}
path_to_datarequest

# naar dendro-folder
for (i in 1:length(dendro_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(dendro_stat[[i]], paste0(path_to_datarequest, "BR_niveau/", names(dendro_stat)[i], ".csv")) 
}

for (i in 1:length(reg_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(reg_stat[[i]], paste0(path_to_datarequest, "BR_niveau/", names(reg_stat)[i], ".csv")) 
}

# naar veg-folder
for (i in 1:length(veg_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(veg_stat[[i]], paste0(path_to_datarequest, "BR_niveau/", names(veg_stat)[i], ".csv")) 
}

```

Ook rechtstreeks naar gdrive


```{r list_export_gdrive, eval = FALSE}
path_to_datarequest_gdrive

# naar dendro-folder
for (i in 1:length(dendro_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(dendro_stat[[i]], paste0(path_to_datarequest_gdrive, "BR_niveau/", names(dendro_stat)[i], ".csv")) 
}

for (i in 1:length(reg_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(reg_stat[[i]], paste0(path_to_datarequest_gdrive, "BR_niveau/", names(reg_stat)[i], ".csv")) 
}

# naar veg-folder
for (i in 1:length(veg_stat)){
	  # selectie <- list_dendro[[i]]
	  # naam <- paste0(names(list_dendro)[i], ".csv")
	  write.csv2(veg_stat[[i]], paste0(path_to_datarequest_gdrive, "BR_niveau/", names(veg_stat)[i], ".csv")) 
}

```

