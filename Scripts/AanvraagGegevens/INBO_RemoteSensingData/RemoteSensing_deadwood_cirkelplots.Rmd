---
title: "Remote sensing INBO"
subtitle: "Liggend dood hout cirkelplots"
author: "Anja Leyman"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: FALSE
    number_sections: yes
    fig_caption: yes
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
---


```{r Rm, eval = FALSE}
rm(list=ls())
```

```{r Setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE, 
  fig.width = 7,
  fig.height = 3,
  fig.align = TRUE)

library(here)
library(writexl)
library(scales)
library(sf)


# libraries & invoergegevens
source(here::here("scripts/Setup.R"))

```


```{r Setup2}
path_to_project <- "C:/03_BR/3_AanvraagGegevens/INBO_RemoteSensingData"
path_to_project_teamdrive <- paste0(path_to_output_gdrive, "INBO_RemoteSensingData")

path_to_datarequest <- paste0(path_to_project, "/output/")
path_to_datarequest_teamdrive <- paste0(path_to_project_teamdrive, "/output/")
path_to_html_teamdrive <- path_to_datarequest_teamdrive
path_to_html <- path_to_datarequest

path_to_datacontrol <- paste0(path_to_project_teamdrive, "/datacontrole/")

```


# Vraagstelling

Testdata om hoeveelheid dood hout via remote sensing te bepalen.    

Vraag van luc DK ism Myrte Matthijs:     

 - shapefile met lijnen liggend dood hout voor controle op scherm (enkel CP's)
 - volume logs per plot ter validatie

Zie ook script "RemoteSensing_trees_cirkelplots.Rmd" voor:    

- staand dood hout (samen met levende bomen): op spilniveau    
- volume logs op plotniveau (`dendro_by_plot`)     

Onderstaand script focust op individuele elementen liggend dood hout.

**Concreet:**    

- shapefile liggend dood hout uit cirkelplots
- maximale diameter
- totale lengte (? en/of lengte binnen cirkelplot?)



```{r results='hold', eval=TRUE}
path_to_fieldmap_db
path_to_datarequest
path_to_datarequest_teamdrive

```

# Invoer gegevens

## Load lookuplijsten

```{r load_lkp}
con <- odbcConnectAccess2007(path_to_fieldmap_db)

  qSpecies <- sqlFetch(con, "qSpecies", stringsAsFactors = FALSE)
  qDecaystage <- sqlFetch(con, "qdecaystage", stringsAsFactors = FALSE)
  qVdagnVfm <- sqlFetch(con, "qVdagnVfm", stringsAsFactors = FALSE)

  qcommonremark <- sqlFetch(con, "qcommonremark", stringsAsFactors = FALSE)
  
odbcClose(con)

# 
qSpecies <- qSpecies %>% select(ID, name_nl = Value1, name_sc = Value2)
qDecaystage <- qDecaystage %>% select(ID, decaystage_txt = Value1)
qVdagnVfm <- qVdagnVfm %>% select(ID, intact_fragm_txt = Value1)
```

## Load plotinfo

Plotinfo samenstellen, zijnde plottype, naam forest_reserve en info over survey en data al dan niet processed.
Bijkomend ook afmetingen cirkelplots uit plotdetails.

Ale bosreservaten hebben een opname in periode 2, die loopt van 2010 tot 2018.

```{r plotinfo, results = 'hide'}
plotinfo_ <- load_plotinfo(database = path_to_fieldmap_db, 
                          processed = FALSE, plottype = "CP")
names(plotinfo_)
table(plotinfo_$period, plotinfo_$year_dendro)
table(plotinfo_$period, plotinfo_$forest_reserve)
table(plotinfo_$forest_reserve, plotinfo_$period)
# alle bosreservaten hebben een opname in periode 2
# loopt van 2010 tot 2018

```

```{r}

plotinfo_ %>% 
  filter(data_processed == FALSE & survey_trees == TRUE & period == 2) %>% 
  nrow() == 0

plotinfo_ %>% 
  filter(data_processed == TRUE& survey_trees == TRUE & period == 2) %>%
  nrow()
# 881
```
We selecteren de opnameperiode die het nauwste aansluit bij 2013-2015.
Dat blijkt overal periode 2 te zijn.

Alle cirkelplots uit periode 2 zijn processed.

```{r}
plotinfo <- plotinfo_ %>% 
  filter(survey_trees & data_processed & period == 2)
```

We  voegen hier info mbt straal A3 en A4 aan toe.

```{r plotdetails}
con <- odbcConnectAccess2007(path_to_fieldmap_db)
  plotdetails_ <- sqlFetch(con, "PlotDetails_2eSET", stringsAsFactors = FALSE)
odbcClose(con)

# names(plotdetails_)

plotdetails <- plotdetails_ %>% 
  mutate(period = 2) %>% 
  select(plot_id = IDPlots, period, 
         contains(c("rA")),
         TresHoldDBH_Trees_A3_alive,
         TresHoldDBH_Trees_A4_alive,
         TresHoldDBH_Trees_A3_dead,
         TresHoldDBH_Trees_A4_dead
         ) 

nrow(plotdetails)
# 17
table(plotdetails$rA4, plotdetails$rA3)
  #     9  12  15  20
  # 15   0   0  30   0
  # 18 762   0   0   0
  # 20   0   0   0  25
  # 30   0  64   0   0

```


```{r combine}
plotinfo <- plotinfo %>% 
  inner_join(plotdetails, by = c("plot_id", "period"))

n_distinct(plotinfo$plot_id) == nrow(plotinfo)
```



```{r table_A3A4}
plotinfo %>% group_by(rA3, rA4) %>% 
  summarize(n_plots = n()) %>% 
  ungroup %>% 
  select("aantal plots" = n_plots, 
         "straal A3 (m)" = rA3,
         "straal A4 (m)" = rA4,
         ) %>% 
  DT::datatable(filter = "none", selection = "none", rownames = FALSE, 
                options = list(dom = 'tip'))

```


## Load XY

Globale XY-coördinaten van centrum cirkelplots inladen:      

- uit tabel `GPSReferencePoints` fieldmap    
- uit shapefile voor Kluisbos   


```{r xy_FM}
con <- odbcConnectAccess2007(path_to_fieldmap_db)
  xy_FM <- sqlFetch(con, "GPSReferencePoints", stringsAsFactors = FALSE)
odbcClose(con)

```


```{r xy_shape, results= 'hide'}
# shp_monitoring_CP <- paste0(path_to_shp, "alle_cirkelplots/Bosreservaten_allecirkels.shp")
# shp_monitoring_all <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_lam72_basisversie.shp")
shp_pt_path <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_centraalpunt_lam72_metinfo.shp")

shp_pt <- sf::st_read(shp_pt_path) 

class(shp_pt)
# [1] "sf"         "data.frame"
names(shp_pt)
unique(shp_pt$PlotType)

# check: 1 coordinaat per CP
shp_pt %>% st_drop_geometry() %>%
  filter(PlotType %in% c("circular nested plots", "circular plot")) %>% 
  group_by(PlotID) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  filter(n > 1) %>% nrow() == 0

# dataframe met globale coördinaten
xy_shp <- shp_pt %>% 
  st_drop_geometry() %>% 
  filter(PlotType %in% c("circular nested plots", "circular plot")) %>% 
  select(plot_id = PlotID, x_shp = XLambert72, y_shp = YLambert72)

names(xy_shp)
summary(xy_shp)

# xy_shp %>% filter(str_detect(Bos, "luisbos"))

```

Beide samenvoegen tot `xy_all`.

```{r xy_all, results='hide'}
# unieke plotids < plotinfo
names(plotinfo)
names(xy_FM)
nrow(plotinfo)
range(plotinfo$plot_id) #[1]  101 2065

# 
xy_all <- plotinfo %>% 
  dplyr::select(forest_reserve, plot_id) %>% 
  left_join(xy_FM %>% select(plot_id = IDPlots, Xproj_m, Yproj_m))

xy_all %>% filter(is.na(Xproj_m)) %>% select(forest_reserve) %>% unique()
# => enkel Kluisbos ontbreekt
xy_missing <- xy_all %>% filter(is.na(Xproj_m))
xy_kluisbos <- xy_shp %>% 
  filter(plot_id %in% xy_missing$plot_id)

xy_all_ <- xy_all %>% 
  left_join(xy_kluisbos) %>% 
  mutate(x_global_plot = ifelse(is.na(Xproj_m), x_shp, Xproj_m)
         , y_global_plot = ifelse(is.na(Yproj_m), y_shp, Yproj_m)
  ) %>% 
  select(-x_shp, -y_shp, -Xproj_m, -Yproj_m)
xy_all_ %>% filter(is.na(x_global_plot)) %>% nrow() == 0

xy_all <- xy_all_

```

```{r}
names(xy_all)
```

## Load dendro data

Standaard worden enkel de "processed" data ingeladen mbv de load-functies.

```{r load_data, results='hide'}
data_dendro <- load_data_dendrometry(database = path_to_fieldmap_db
                                     , processed = TRUE 
                                     , plottype = "CP"
                                     , extra_variables = TRUE)

data_shoots <- load_data_shoots(database = path_to_fieldmap_db
                                , extra_variables = TRUE)


data_deadwood <- load_data_deadwood(database = path_to_fieldmap_db
                                    , plottype = "CP"
                                    , processed = TRUE)
```


## Load XY deadwood


> ook nog XY start en einde van elke cfr mail van Peter: via accesdb met X en Y voor start en einde
dan met Chatgpt er een lijn van maken
zie "## Load XY deadwood"

> cfr Peter: 
hierbij de Deadwood_data van alle cirkels ingemeten in de 3 meetperiodes (bron dBEls) in 3 xls files !
In Project Manager werden via de tool "Export data" in de Acces dB (PlainSHP setting) de tabellen Deadwood_details gegenereerd.
Via 3 query's zijn tabellen aangemaakt met  plotid, id deadwood, id, x, y, z, diam, lengte, volume, soort, afbraak en bosreservaat.
Uit die query's zijn dan weer 3 xls tabellen geëxporteerd  :
DW_1eSet_XY, DW_2eSet_XY, DW_3eSet_XY
Zoals ik in mijn vorige mail schreef zijn de DW-objecten
opgelijst :  plotid, id deadwood, id (1 en 2) - regel voor begin en einde,
2 regels per object dus.


```{r}

```

Met XY-coördinaten van strat en eindpunt kan ik een shapefile maken

> vb code chatgpt

```{r}
# Install and load the sf package
install.packages("sf")
library(sf)

# Example coordinates for two points
point1 <- c(10, 20)  # Replace with actual coordinates
point2 <- c(30, 40)  # Replace with actual coordinates

# Combine points into a matrix
coords <- rbind(point1, point2)

# Create a line from the points
line <- st_linestring(coords)

# Create an sf object
line_sf <- st_sfc(line)

# Set the CRS (EPSG:4326 for WGS84)
st_crs(line_sf) <- 4326

# Save the sf object as a shapefile
st_write(line_sf, "line_shapefile.shp")
```



# Datacontrole

Controle op deadwood, enkel deze behouden in CP's én juiste periode (mbv plotinfo).

```{r check_deadw, results='hide'}
# trees
incorrect_deadw_ <- check_data_deadwood(database = path_to_fieldmap_db) 
incorrect_deadw <- incorrect_deadw_ %>% 
  inner_join(plotinfo %>% select(plot_id, period, forest_reserve)
             , by = c("plot_id", "period"))

nrow(incorrect_deadw) # 286
# view(incorrect_deadw)

table(incorrect_deadw$anomaly)
# missing too low 
#       7       1
```

```{r eval = FALSE}
write.xlsx(incorrect_deadw
           , paste0(path_to_datacontrol, "incorrect_deadw.xlsx")
           , sheetName = "incorrect_deadw"
           , showNA = FALSE
           , append = FALSE)
```



# Herinvoer gegevens

## Load dendro data

Enkel data in CP's, periode 2 én processed: selectie mbv plotinfo (inner_join).

```{r load_data2, results='hide'}
# Standaard worden enkel de "processed" data ingeladen mbv de load-functies.
data_dendro <- load_data_dendrometry(database = path_to_fieldmap_db
                                     , plottype = "CP"
                                     , extra_variables = TRUE) %>% 
  inner_join(plotinfo %>% select(plot_id, period)
             , by = c("plot_id", "period"))

data_shoots <- load_data_shoots(database = path_to_fieldmap_db
                                , extra_variables = TRUE)

# door shoots en trees te combineren,  blijft enkel gewenst BR over
data_stems  <- compose_stem_data(data_dendro, data_shoots
                                 , extra_variables = TRUE)

height_model <- load_height_models()

# data deadwood hier niet nodig, maar wel om functies te kunnen runnen
data_deadwood <- load_data_deadwood(database = path_to_fieldmap_db
                                    , processed = TRUE) %>% 
  inner_join(plotinfo %>% select(plot_id, period)
             , by = c("plot_id", "period"))

nrow(data_deadwood)
```

# Basisvariabelen


```{r}
names(data_deadwood)

data_deadwood <- data_deadwood %>% 
  select(forest_reserve, plot_id, period, year, date_dendro,
         lying_deadw_id, species, decaystage, intact_fragm,
         calc_volume_m3, 
         lenght_inside_plot_m = calc_length_m, total_length_m,
         min_diam_mm, max_diam_mm, dbh_class_5cm)

table(data_deadwood$year)
```

# Controle op NA's

```{r results='hide'}
names(data_deadwood)
```

```{r data_deadwood, results='hide'}
col <- c("lenght_inside_plot_m","total_length_m", 
         "min_diam_mm", "max_diam_mm",
         "dbh_class_5cm")

data_deadwood %>% filter_at(col, any_vars(is.na(.))) %>% nrow() == 0

```

# Coördinaten

Shapefile uit Fieldmap halen, en via deadwood_id koppelen aan data_deadwood. 

XY-coördinaten Lambert 72 (positie) : lokale coördinaten uit FM omzetten naar globale coördinaten

```{r results='hide'}
names(data_deadwood)

result_deadw <- data_deadwood %>% 
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  left_join(qVdagnVfm, by = c("intact_fragm" = "ID")) %>%
  left_join(qDecaystage, by = c("decaystage" = "ID")) %>% 
  select(forest_reserve, plot_id, period, year, date_dendro
         , lying_deadw_id
         , species, name_nl, name_sc
         , min_diam_mm, max_diam_mm, dbh_class_5cm,
         # , alive_dead, alive_dead_txt
         , intact_fragm, intact_fragm_txt

         , decaystage, decaystage_txt
         # , x_local, y_local
         )

names(result_deadw)
summary(result_deadw)
```

> ev. Toevoegen van globale XY-coördinaten uit shapefile van deadwood. 

```{r }
XY_global <- GPSReferencePoints %>% 
  select(plot_id = IDPlots, x_global_plot = Xproj_m, y_global_plot = Yproj_m) %>% # , Altitude_m
  inner_join(plotinfo %>% select(plot_id))
# geen periode: één plot doorheen de periodes ...

```

## TEMP - check coordinaten

Zijn er van elke cirkelplot coördinaten?

```{r}
plotinfo_xy_global <- plotinfo %>% 
  left_join(GPSReferencePoints %>% 
              select(plot_id = IDPlots
                     , x_global_plot = Xproj_m, y_global_plot = Yproj_m)) 

no_xy <- plotinfo_xy_global %>% 
  filter(is.na(x_global_plot) | is.na(y_global_plot))
```

XY ontbreekt voor Kluisbos, maar is wel beschikbaar in de shapefile.

```{r xy_shape}
 # aangemaakt door M.Esprit
shp_monitoring_CP <- paste0(path_to_shp, "alle_cirkelplots/Bosreservaten_allecirkels.shp")

shp_monitoring_all <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_lam72_basisversie.shp")

shp_monitoring_pt <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_centraalpunt_lam72_metinfo.shp")

```


```{r}
# shp_plots <- sf::st_read(shp_monitoring_CP)  
# shp_plots <- sf::st_read(shp_monitoring_all) 
shp_plots <- sf::st_read(shp_monitoring_pt) 


class(shp_plots)
# [1] "sf"         "data.frame"
names(shp_plots)
unique(shp_plots$PlotType)

shp_plotids <- shp_plots %>% 
  st_drop_geometry() %>%
  group_by(PlotID) %>% 
  summarize(n = n()) %>% 
  ungroup()

shp_df <- shp_plots %>% 
  st_drop_geometry() %>% 
  # select(plot_id = PlotID, Bos, x_shp = X_m, y_shp = Y_m, plottype_shp = PlotType, rA4_shp = PlotSize)
  # select(plot_id = PlotID, x_shp = X_m, y_shp = Y_m)
  select(plot_id = PlotID, x_shp = XLambert72, y_shp = YLambert72)

names(shp_df)
summary(shp_df)

# shp_df %>% filter(str_detect(Bos, "luisbos"))

```

Zijn de coördinaten van de shapefile dezelfde als deze in FieldMap?

NEE

```{r vgl_xy_shp_fm}
vgl <- plotinfo_xy_global %>% 
  select(plot_id, forest_reserve, x_global_plot, y_global_plot) %>% 
  left_join(shp_df, by = c("plot_id"))

names(vgl)

t <- vgl %>% filter((abs(x_global_plot - x_shp) > 2) | 
                      (abs(y_global_plot - y_shp) > 2))

```


## Toevoegen globale coördinaten

Nog te kiezen: obv tabel uit Fieldmap of obv shapefile - gevraagd aan Marc, mail van 4/7

Sowieso voor Kluisbos shapefile nodig (geen info in Fieldmap).

```{r}
result_stems_ <- result_stems %>% 
  left_join(XY_global, by = c("plot_id")) %>% 
  mutate(x_global = x_local + x_global_plot,
         y_global = y_local + x_global_plot) %>% 
  select(-x_global_plot, -x_global_plot)

result_stems_ %>% filter(is.na(x_global) | is.na(y_global)) %>% nrow() == 0
names(result_stems_)  
  
result_stems <- result_stems_
  
```


# Shapefiles kernvlaktes

In ArcGIS de kernvlaktes en transecten geselecteerd uit "boseco_alleproefvlakken_lam72_basisversie.shp"
(folder G:/Gedeelde drives/Team_Boseco_BR/PRJ_BR_AanvraagGegevens/00_METADATA-ALL_PLOTS/GIS-lagen bosreservaten/alle proefvlakken gecombineerd)

Weggeschreven naar folder ".../GIS-lagen bosreservaten/alle_kernvlaktes" 
als "Bosreservaten_KernvlaktesTransecten.shp"

Vervolgens de 17 strikte kernvlaktes geselecteerd en weggeschreven als "kernvlaktes_strikt.shp".

```{r}
shp_monitoring_all <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_lam72_basisversie.shp")

shp_monitoring_pt <- paste0(path_to_shp, "alle_proefvlakken_gecombineerd/boseco_alleproefvlakken_centraalpunt_lam72_metinfo")

```


```{r}
shp_core_area <- sf::st_read(shp_core_area)   # aangemaakt door M.Esprit
class(shp_core_area)
# [1] "sf"         "data.frame"
names(shp_core_area)
unique(shp_core_area$PlotYype)

shp_plotids <- shp_core_area %>% 
  st_drop_geometry() %>%
  group_by(PlotID) %>% 
  summarize(n = n()) %>% 
  ungroup()

shp_df <- shp_core_area %>% 
  st_drop_geometry()
```


# Export

De gegegevens op spilniveau - "result_stems.xlsx" - worden weggeschreven naar de c-schijf en de teamdrive.

De shapefile met de perimeters van de kernvlaktes staat op dezelfde plaats (als zip). 


**Enkele verduidelijkingen:**    

* "plot_id" = link naar de shapefile van de kernvlaktes (IDPlots)    
* height_measured = effectief gemeten    
* height_modeled = op basis van dh-curves   
* x_global & y_global: Lambert 72   
* x_local & y_local: coördinaten ten opzichte van een centraal punt in de kernvlakte   


```{r}
path_to_datarequest
path_to_datarequest_teamdrive

```



```{r save, eval=FALSE}
write.xlsx(result_stems
           , paste0(path_to_datarequest, "result_stems_kernvlaktes.xlsx")
           , sheetName = "stems"
           , showNA = FALSE
           , append = FALSE) 


```


```{r save_teamdrive, eval=FALSE}
write.xlsx(result_stems
           , paste0(path_to_datarequest_teamdrive,
                    "result_stems_kernvlaktes.xlsx")
           , sheetName = "stems"
           , showNA = FALSE
           , append = FALSE) 

```

# Copy html to teamdrive

Na knitting - manueel

```{r eval = FALSE}
# Specify the path of the file you want to copy
source_file <- here::here(paste0("Scripts/AanvraagGegevens/INBO_RemoteSensingData/RemoteSensing_deadwood_cirkelplots.html"))

# Specify the destination directory where you want to copy the file
destination_dir <- path_to_html_teamdrive

# Copy the file to the destination directory
file.copy(from = source_file, to = destination_dir, overwrite = TRUE)
# ? file.copy
```
