---
title: "Statistieken dendro per bosreservaat"
author: "Anja Leyman"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: FALSE
    number_sections: yes
    fig_caption: yes
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---

# Setup

```{r Rm, eval = FALSE}
rm(list=ls())
```

```{r Setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE, 
  fig.width = 9,
  fig.align = TRUE)

library(here)

# libraries & invoergegevens
source(here::here("scripts/Setup.R"))

```

# Inladen lookuplijsten

```{r read_forresdat1, eval=FALSE}
qIufroheight <- read_forresdat("qiufroheight", repo_path = path_to_git_forresdat, join_plotinfo = FALSE)

# list.files(paste0(path_to_git_forresdat, "data/"))

```

```{r fetch_access}
con <- odbcConnectAccess2007(path_to_fieldmap_db)

qIndShootCop <- sqlFetch(con, "qIndShootCop", stringsAsFactors = FALSE)
qAliveDead <- sqlFetch(con, "qAliveDead", stringsAsFactors = FALSE)
qSpecies <- sqlFetch(con, "qspecies", stringsAsFactors = FALSE)
qDecaystage <- sqlFetch(con, "qdecaystage", stringsAsFactors = FALSE)

odbcClose(con)

qIndShootCop <- qIndShootCop %>% select(-Value3, -OrderField, -Active)
qAliveDead <- qAliveDead %>% select(-Value3, -OrderField, -Active)
qSpecies <- qSpecies %>% select(-Value3, -OrderField, -Active)
qDecaystage <- qDecaystage %>% select(-Value3, -OrderField, -Active, -MasterID)
```




# Inladen plotinfo

```{r read_forresdat2}
plotinfo <- read_forresdat("plotinfo", repo_path = path_to_git_forresdat, join_plotinfo = FALSE)

```


```{r read_tsv, eval=FALSE}
plotinfo <- read_vc(file = "plotinfo", root = path_to_forresdat_data)

```


# Inladen plot data

```{r read_forresdat3}
dendro_by_plot <- read_forresdat("dendro_by_plot", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg")) # (veg en reg)
 
dendro_by_plot_species <- read_forresdat("dendro_by_plot_species", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg")) %>%  # (veg en reg)
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2) 

dendro_by_diam_plot <- read_forresdat("dendro_by_diam_plot", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg"))  # (veg en reg)

dendro_by_diam_plot_species <- read_forresdat("dendro_by_diam_plot_species", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg")) %>%  # (veg en reg)
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2) 

logs_by_decay_plot <- read_forresdat("logs_by_decay_plot", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg")) %>%  # (veg en reg) 
  left_join(qDecaystage, by = c("decaystage" = "ID")) %>% 
  rename(decaystage_code = decaystage,
         afbraak = Value1, 
         decay_stage = Value2) 

logs_by_decay_plot_species <- read_forresdat("logs_by_decay_plot_species", repo_path = path_to_git_forresdat, join_plotinfo = TRUE) %>% 
  select(-contains("eg")) %>%  # (veg en reg)
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2)  %>% 
  left_join(qDecaystage, by = c("decaystage" = "ID")) %>% 
  rename(decaystage_code = decaystage,
         afbraak = Value1, 
         decay_stage = Value2) 
```

```{r read_tsv_join, eval=FALSE}
plotinfo_dendro <- plotinfo %>% select(-survey_reg, -survey_veg)

dendro_by_plot <- read_vc(file = "dendro_by_plot", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year"))

dendro_by_plot_species <- read_vc(file = "dendro_by_plot_species", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year")) %>% 
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2) 

dendro_by_diam_plot <- read_vc(file = "dendro_by_diam_plot", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year"))

dendro_by_diam_plot_species <- read_vc(file = "dendro_by_diam_plot_species", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year")) %>% 
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2) 

logs_by_decay_plot <- read_vc(file = "logs_by_decay_plot", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year")) %>% 
  left_join(qDecaystage, by = c("decaystage" = "ID")) %>% 
  rename(decaystage_code = decaystage,
         afbraak = Value1, 
         decay_stage = Value2) 

logs_by_decay_plot_species <- read_vc(file = "logs_by_decay_plot_species", root = path_to_forresdat_data) %>% 
  left_join(plotinfo_dendro, by = c("plot_id", "period", "year")) %>% 
  left_join(qSpecies, by = c("species" = "ID")) %>% 
  rename(name_nl = Value1, 
         name_sc = Value2)  %>% 
  left_join(qDecaystage, by = c("decaystage" = "ID")) %>% 
  rename(decaystage_code = decaystage,
         afbraak = Value1, 
         decay_stage = Value2) 

```


# Statistieken

## Dendro_by_plot

```{r data}
dataset <- dendro_by_plot %>%
  filter(plottype == "CP")   # enkel cirkelplots

table(dataset$forest_reserve, dataset$period)
```

```{r variables}
# names_plotinfo <- names(plotinfo)
# 
# variables_ <- names(dendro_by_plot) 
# 
# variables_for_statistics <- variables_[!variables_ %in% names_plotinfo & variables_ != "year"]
# variables_for_statistics

# korter
variables_for_statistics <- dataset %>% 
  select(contains(c("_ha", "_species"))) %>% 
  names()

variables_for_statistics

```

```{r stat}
resultaat <- create_statistics(
  dataset = dataset,
  level = c("period", "forest_reserve"),
  variables = variables_for_statistics,
  include_year_range = FALSE
  ) %>% 
  round_df(., 2) %>% 
  # rename(strata = forest_reserve) %>% 
  mutate(strata = NA,
         stratum_name = NA,
         strata2 = NA,
         stratum_name2 = NA)


str(resultaat)
head(resultaat)
```

```{r export}
My.ResultsToDatabase(results = resultaat, 
                     dbHandle = dbResults, 
                     tblName = "tblResultaten", 
                     scriptName = "dendro_per_BR.Rmd", 
                     description = "mean dendro per ha per bosreservaat en per periode",
                     request_from = "Team bosecologie",
                     run_by = "AL")
```



## Dendro_by_plot_species

!! oppassen met 0 waardes (zitten niet in tabel: zie ook dataverwerking ikv artikel C).
Moeten eerst toegevoegd worden.

Zie ook script `INBO_biomassa_vglBR_VBI/meanNGV_per_bms_levend_dood_PNV.Rmd`, daar gebruik gemaakt van add_zeros

Boomsoort als level: enkel indien ik ook alle nulwaardes mee heb om een gemiddelde over alle plots heen te maken! 
bv. appel
=> met functie `add_zeros` nullen toevoegen
! lukt enkel als ik alle overbodige velden verwijder!!

OPGEPAST: forest_reserve achteraf terug toevoegen, niet meenemn bij add_zeros,
anders voor elke plot, alle bosreservaten toegevoegd met 0 voor alle soorten


```{r data}
dataset2 <- dendro_by_plot_species %>%
  filter(plottype == "CP")   # enkel cirkelplots

table(dataset2$forest_reserve, dataset2$period)
```


```{r add_zeros_all_species}
dataset2_0 <- add_zeros(dataset = dataset2 %>% 
                          select(plot_id, period, species, contains("_ha")),
                        comb_vars = c("plot_id", "species"),
                        grouping_vars = c("period")
                        ) %>%
  left_join(qSpecies %>% dplyr::select(species = ID, speciesTxt = Value1)) %>% 
  left_join(plotinfo %>% select(plot_id, forest_reserve))

# FOUT: pas achteraf terug bosreservaat toevoegen
# anders voor elke plot, elk bosreservaar met nummen
# bv. Wijnendale: plot 101, ... ipv enkel 401

```
```{r}
variables_for_statistics2 <- dataset2_0 %>% 
  select(contains("_ha")) %>% 
  names()

variables_for_statistics2
#
```


```{r}
# !! één resultaat per soort en per BR
n_BR <- dataset2 %>% distinct(forest_reserve) %>% nrow()
n_BR <- length(unique(dataset2$forest_reserve))
n_species <- length(unique(dataset2$species))
n_period <- length(unique(dataset2$period))
n <- n_BR * n_species * 2 * length(variables_for_statistics2)
n # 20768
# DAAROM: 0 en NA (xxxx_min40cm) verwijderen

resultaat2 <- create_statistics(
  dataset = dataset2_0,
  level = c("period", "forest_reserve", "speciesTxt"),
  # level = c("period", "forest_reserve", "name_nl"),
  # level = c("period"),
  variables = variables_for_statistics2,
  # variables = "basal_area_alive_m2_ha",
  include_year_range = FALSE,
  na_rm = FALSE,
    interval_information = suppressMessages(read_csv2(system.file("extdata/class_data.csv",
    package = "forrescalc")))
  ) %>% 
  select(-logaritmic) %>% 
  # filter(mean != 0 & !is.na(mean)) %>% 
  round_df(., 2) %>% 
  # rename(strata = forest_reserve) %>% 
  mutate(strata = "species",
         stratum_name = speciesTxt,
         strata2 = NA,
         stratum_name2 = NA)
summary(dataset2_0)
```

? waarom n_obs 240 voor stamtal en 120 voor alle rest?? (wijnendale, maar bij alle BR-en!!)
blijkt steeds de eerste variabele te zijn? 
Was niet zo bij statistics zonder soort als level


```{r}

names(dataset2_0)

resultaat_test <- create_statistics(
  dataset = dataset2_0,
  level = c("period", "forest_reserve", "speciesTxt"),
  # level = c("period", "forest_reserve", "name_nl"),
  # level = c("period"),
  # variables = variables_for_statistics2,
  variables = c("basal_area_alive_m2_ha", "number_of_trees_ha", "vol_alive_m3_ha"),
  include_year_range = FALSE,
  na_rm = FALSE,
    interval_information = suppressMessages(read_csv2(system.file("extdata/class_data.csv",
    package = "forrescalc")))
  ) %>% 
  select(-logaritmic) %>% 
  # filter(mean != 0 & !is.na(mean)) %>% 
  round_df(., 2) %>% 
  # rename(strata = forest_reserve) %>% 
  mutate(strata = "species",
         stratum_name = speciesTxt,
         strata2 = NA,
         stratum_name2 = NA) %>% 
  filter(forest_reserve == "Wijnendalebos")


table(resultaat_test$variable, resultaat_test$n_obs)
```


```{r check_add_zeros}
totaal_NGV_per_BR <- resultaat2 %>% 
  filter(variable == "basal_area_alive_m2_ha") %>% 
  group_by(period, forest_reserve) %>% 
  summarize(G = sum(mean)) %>% 
  ungroup()

# vgl met Result_NGV_per_PNV obv analyseset (zonder soorten)
check_NGV <- totaal_NGV_per_BR %>% 
  left_join(resultaat %>% filter(variable == "basal_area_alive_m2_ha") 
            , by = c("period", "forest_reserve")) %>% 
  mutate(verschil = G - mean)
```




```{r export2}
My.ResultsToDatabase(results = resultaat2, 
                     dbHandle = dbResults, 
                     tblName = "tblResultaten", 
                     scriptName = "dendro_per_BR.Rmd", 
                     description = "mean dendro per ha per bosreservaat en per periode - per soort",
                     request_from = "Team bosecologie",
                     run_by = "AL")
```


```{r tmp}
  
  
stat <- create_statistics(
  dataset = dataset,
  level = c("period", "forest_reserve"),
  variables = variables,
  include_year_range = FALSE
  ) %>% 
  round_df(., 2) %>% 
  # rename(strata = forest_reserve) %>% 
  mutate(strata = NA,
         stratum_name = NA,
         strata2 = NA,
         stratum_name2 = NA)




Resultaat
Resultaat[5:8] <- round(Resultaat[5:8],2)

vars <- c("period", "speciesTxt")
Result_NGV_per_PNV_per_species <- Resultaat %>%
  mutate_at(vars, factor) %>% 
  left_join(qPNV, by = c("PNV" = "PNVcde"))

unique(Result_NGV_per_PNV_per_species$variable)
# [1] "basal_area_alive_m2_ha" "number_of_trees_ha"     "vol_alive_m3_ha"       
# [4] "vol_deadw_m3_ha" 

# controle
# som moet gelijk zijn aan G per pnv
names(resultaat2)
names(resultaat)
```







```{r variables}
names_plotinfo <- names(plotinfo)

variables_ <- names(dendro_by_plot_species) 

variables <- variables_[!variables_ %in% names_plotinfo & !variables_ %in% c("name_nl", "name_sc", "species")]
variables

```

```{r stat}
stat <- create_statistics(
  dataset = dataset,
  level = c("period", "forest_reserve", "name_nl"),
  variables = variables,
  include_year_range = FALSE
  ) %>% 
  round_df(., 2) %>% 
  mutate(strata = "species") %>% 
  rename(stratum_name = name_nl) %>% 
  mutate(strata2 = NA,
         stratum_name2 = NA)


str(stat)
head(stat)
```

```{r export}
My.ResultsToDatabase(results = stat, 
                     dbHandle = dbResults, 
                     tblName = "tblResultaten", 
                     scriptName = "dendro_per_BR.Rmd", 
                     description = "mean dendro per species per ha per bosreservaat",
                     request_from = "Team bosecologie",
                     run_by = "AL")
```


proberen om één grote functie te maken voor alle dendro_by_plot_xxxx_xxxx data


